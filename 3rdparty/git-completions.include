# this script installs git autocompletion stuff for zsh and BASH

if [ "$PROVISION_HAVE_ROOT" = "NO" ] ; then
	# we only want to do a non-privileged install

	printf "INFO: installing git autocompletion plugins"
	GITCOMPLETE_URL_BASE='https://raw.githubusercontent.com/git/git/master/contrib/completion'
	GITCOMPLETE_URL_BASH="$GITCOMPLETE_URL_BASE/git-completion.bash"
	GITCOMPLETE_URL_ZSH="$GITCOMPLETE_URL_BASE/git-completion.zsh"
	printf "."

	if [ -d "$THIRDPARTY_DIR/git-completion" ] ; then
		rm -r "$THIRDPARTY_DIR/git-completion"
	fi

	if [ -L "$THIRDPARTY_DIR/git-completion" ] ; then
		rm "$THIRDPARTY_DIR/git-completion"
	fi

	mkdir -p "$THIRDPARTY_DIR/git-completion"
	if [ ! -d "$THIRDPARTY_DIR/git-completion" ] ; then
		echo " FAIL"
		echo "PANIC: failed to create '$THIRDPARTY_DIR/git-completion'"
		exit 1
	fi
	printf "."

	curl -LSs "$GITCOMPLETE_URL_BASH" -o "$THIRDPARTY_DIR/git-completion/git-completion.bash"
	printf "."
	curl -LSs "$GITCOMPLETE_URL_ZSH" -o "$THIRDPARTY_DIR/git-completion/git-completion.zsh"
	printf "."

	if [ -e "$HOME/.git-completion.bash" ] ; then
		rm "$HOME/.git-completion.bash"
	fi

	if [ -e "$HOME/.zsh/git-completion.zsh" ] ; then
		rm "$HOME/.zsh/git-completion.zsh"
	fi
	printf "."

	if ! ln -s "$THIRDPARTY_DIR/git-completion/git-completion.bash" "$HOME/.git-completion.bash" > /dev/null 2>&1 ; then
		echo " FAIL"
		echo "PANIC: failed to link $HOME/.git-completion.bash"
		exit 1
	fi


	if ! ln -s "$THIRDPARTY_DIR/git-completion/git-completion.zsh" "$HOME/.zsh/git-completion.zsh" > /dev/null 2>&1 ; then
		echo " FAIL"
		echo "PANIC: failed to link $HOME/.zsh/git-completion.zsh"
		exit 1
	fi

	echo " DONE"
fi
